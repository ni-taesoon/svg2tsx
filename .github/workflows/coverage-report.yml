name: Coverage Report

on:
  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) ì‹¤í–‰
  schedule:
    - cron: '0 0 * * *'
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests with coverage
        run: bun run test:coverage --run
        continue-on-error: true

      - name: Generate coverage summary
        id: coverage
        run: |
          # JSON ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ íŒŒì‹±
          if [ -f "coverage/coverage-summary.json" ]; then
            LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)
            FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
            BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
          else
            LINES="N/A"
            STATEMENTS="N/A"
            FUNCTIONS="N/A"
            BRANCHES="N/A"
          fi

          echo "lines=$LINES" >> $GITHUB_OUTPUT
          echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT

          # ë‚ ì§œ
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const date = '${{ steps.coverage.outputs.date }}';
            const lines = '${{ steps.coverage.outputs.lines }}';
            const statements = '${{ steps.coverage.outputs.statements }}';
            const functions = '${{ steps.coverage.outputs.functions }}';
            const branches = '${{ steps.coverage.outputs.branches }}';

            // ì»¤ë²„ë¦¬ì§€ ìƒíƒœ ì´ëª¨ì§€
            const getStatus = (pct) => {
              if (pct === 'N/A') return 'âšª';
              const num = parseFloat(pct);
              if (num >= 80) return 'ğŸŸ¢';
              if (num >= 60) return 'ğŸŸ¡';
              return 'ğŸ”´';
            };

            const body = `## ğŸ“Š ì¼ê°„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸

            **ìƒì„±ì¼**: ${date}
            **ì»¤ë°‹**: ${context.sha.substring(0, 7)}
            **ë¸Œëœì¹˜**: ${context.ref.replace('refs/heads/', '')}

            ### ì»¤ë²„ë¦¬ì§€ ìš”ì•½

            | í•­ëª© | ì»¤ë²„ë¦¬ì§€ | ìƒíƒœ |
            |------|----------|------|
            | Lines | ${lines}% | ${getStatus(lines)} |
            | Statements | ${statements}% | ${getStatus(statements)} |
            | Functions | ${functions}% | ${getStatus(functions)} |
            | Branches | ${branches}% | ${getStatus(branches)} |

            ### ëª©í‘œ ëŒ€ë¹„ í˜„í™©

            | ë ˆì´ì–´ | ëª©í‘œ | í˜„ì¬ ìƒíƒœ |
            |--------|------|-----------|
            | entities/ | 90%+ | - |
            | features/ | 80%+ | - |
            | widgets/ | 70%+ | - |

            ---
            ğŸ”— [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š ì¼ê°„ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ - ${date}`,
              body: body,
              labels: ['coverage-report', 'automated']
            });
